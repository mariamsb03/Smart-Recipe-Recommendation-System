name: ML Model CI/CD Pipeline

on:
  pull_request:
    branches: [dev]
  push:
    branches: [dev, staging, main]

env:
  DAGSHUB_USERNAME: mariamsb03
  DAGSHUB_REPO: Smart-Recipe-Recommendation-System
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # Job 1: Run tests on PR to dev
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run unit tests
        run: pytest tests/unit/
      
      - name: Run integration tests
        run: pytest tests/integration/
      
      - name: Run end-to-end tests
        run: pytest tests/e2e/

  # Job 2: Build and push to DockerHub on push to dev
  build:
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install MLflow
        run: pip install mlflow dagshub
      
      - name: Fetch latest model from DagsHub
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: python scripts/fetch_model.py
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:dev .
      
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKERHUB_USERNAME }} --password-stdin
      
      - name: Push to DockerHub
        run: docker push ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:dev

  # Job 3: Deploy to staging
  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v3
      
      - name: Fetch and build with production model
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install mlflow dagshub
          python scripts/fetch_model.py
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:staging .
      
      - name: Push to DockerHub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKERHUB_USERNAME }} --password-stdin
          docker push ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:staging

  # Job 4: Deploy to production
  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Fetch production model from MLflow
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          pip install mlflow dagshub
          python scripts/fetch_model.py
      
      - name: Build production Docker image
        run: |
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:latest .
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:$(cat models/model_version.txt) .
      
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKERHUB_USERNAME }} --password-stdin
      
      - name: Push to DockerHub
        run: |
          docker push ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:latest
          docker push ${{ env.DOCKERHUB_USERNAME }}/recipe-recommender:$(cat models/model_version.txt)
      
      - name: Deploy to Cloud (Railway/Koyeb)
        run: |
          # Add your deployment command here
          # Example for Railway:
          # railway up
